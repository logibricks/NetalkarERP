@model Sciffer.Erp.Domain.ViewModel.ref_mfg_multi_machining_vm
@using Newtonsoft.Json
@{
    ViewBag.Title = "Create";
}

@using (Html.BeginForm("UpdateRecords", "MultiMachining", FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    @Html.AntiForgeryToken()
    <div id="mac_detail"></div>
    <div id="multi_machining_id"></div>
    <div class="form-horizontal" style="margin-top:10px;">

        <div class="row">
            <input type="submit" id="create" class="btn btn-success" value="Create" onclick="TableToJson()" data-controller="MultiMachining" style="float:right;">

            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal"><span class="glyphicon glyphicon-plus"></span>Add</button>
        </div>

        <div class="row">
            <div class="table-responsive">
                <table class="table table-responsive table-bordered table-striped" id="ContactGrid">
                    <thead>

                        <tr>
                            <th><label>Sr. No.</label></th>
                            <th><label>Group ID</label></th>
                            @*<th><label>Machine IDs</label></th>*@
                            <th><label>Machine ID1</label></th>
                            <th><label>Machine 1</label></th>
                            <th><label>Machine ID2</label></th>
                            <th><label>Machine 2</label></th>
                            <th><label>Action</label></th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>


        <div class="modal fade" id="myModal" role="dialog">
            <div class="modal-dialog">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Details</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-md-3">
                                    Machine <span class="required">*</span>
                                </label>
                                <div class="col-md-7">
                                    @Html.DropDownList("machine_id", (new System.Web.Mvc.SelectList(ViewBag.machinelist, "machine_id", "machine_code")), htmlAttributes: new { @class = "form-control machine_id mickey", multiple = "multiple" })
                                </div>
                            </div>
                        </div>
                        <br />
                        <br />
                        <div class="modal-footer">
                            <input type="hidden" id="srno" />
                            <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="clearmodel();">Close</button>
                            <button type="button" class="add btn btn-primary">Add Machine</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
}



@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script src="~/Scripts/RemoveUnexpectedFile.js"></script>
    <script src="~/Scripts/requirevalidation.js"></script>
    <script type="text/javascript">


        $(document).ready(function () {


            var doc_no= '@TempData["doc_num"]';
            if (doc_no != '') {
                if (doc_no != 0) {
                    sweetAlert("", doc_no + " Saved successfully!", "success");
                }
            }

            var t = $('#ContactGrid').DataTable();
            // t.fnClearTable();
            // var rowCount = t.fnGetData().length;


            $.ajax({
                url:'@Url.Action("GetAllMachineForMultiMac", "MultiMachining")',
                method: "POST",
                data: { entity: "get_machine" },
                success:function(data){
                    var i = 1;
                    var sr_no = t.fnGetData().length + 1;
                    $.each(data, function (i, cycle) {

                        i = i + 1;
                        t.fnAddData([i,cycle.machine_group_id, cycle.machine_id1, cycle.machine_name1, cycle.machine_id2, cycle.machine_name2, '']);

                    });

                }

            });

        });

        function  clearmodel()
        {
            $("#machine_id").val("").trigger("change");
            $('.machine_id').multiselect('refresh');

        }


        $('#ContactGrid').DataTable({
            "bSearchable":true,
            "bPaginate": false,
            "ordering": false,
            "bfooter": false,
            "info": false,
            "bLengthChange": false,
            "bAutoWidth": false,
            "bFilter": false,
            "bSort": false,
            aoColumns: [
                     { sname: "a", sWidth: "5%" }, // <th><label>ID</label></th>
                     { sname: "b", sWidth: "5%", bVisible: false },   // <th><label>Sr. No.</label></th>
                     //{ sname: "c", bVisible: false }, // <th><label>Machine IDs</label></th>
                      { sname: "d", bVisible: false }, // <th><label>Machine ID1</label></th>
                     { sname: "e", bVisible: true }, // <th><label>Machine 1</label></th>
                     { sname: "f", bVisible: false },  // <th><label>Machine ID2</label></th>
                     { sname: "g", bVisible: true }, // <th><label>Machine 2</label></th>

                     {
                         sname: "r", sWidth: "8%",
                         bSortable: false,
                         mRender: function (data, type, full) {
                             return '<img class="edit" src="../images/writing_file.png" height="20px" width="25px" alt="Edit"  /> <img class="delete" src="../images/remove.png" height="20px" width="25px" alt="Delete" />';
                         }
                     }]


        });



        // Add Machine -----------------------------------------------------------------------------------------------------------------------------------------------------------------------


        $(".add").on("click", function (event) {
            var t = $('#ContactGrid').DataTable()

            var rowCount = t.fnGetData().length - 1;
            var sr_no = t.fnGetData().length + 1;
            var cc = parseInt(arguments[0]) - 1;
            var machine_id = $("#machine_id").val();
            var mac_names = [];
            var machine = '';
            var selectedMachines = [];

            if ($('.machine_id').val() != undefined) {

                if ($('.machine_id').next('div').find('button').find('span').text().includes("All")) {
                    machine = -1;
                }
                else {
                    if ($('.machine_id :selected').length > 0 && $('.machine_id :selected').length == 2) {



                        $('.machine_id :selected').each(function (i, selected) {
                            var mac = @Html.Raw(JsonConvert.SerializeObject(ViewBag.machinelist));
                            selectedMachines[i] = $(selected).val();
                            var mac_id = mac.filter(a=>a.machine_id ==  $(selected).val());
                            var mac_name = mac_id.map(a=>a.machine_code);
                            mac_names.push(mac_name);
                        });
                        machine = selectedMachines + "";
                    }
                    else
                    {
                        swal("", "Select Two Machines", "error")
                        return false;
                    }
                }
            }
            var machine_id1 = machine_id[0];
            var machine_id2 = machine_id[1];
            var machine_name1 = mac_names[0][0] ;
            var machine_name2 = mac_names[1][0] ;

            var group = t.fnGetData(rowCount)[1];
            if ($("#srno").val() == "") {

                t.fnAddData([sr_no, parseFloat(group)+1, machine_id1, machine_name1, machine_id2, machine_name2, '']);
                rowCount + 1;
                sr_no + 1;
            }
            else {
                var cc = $("#srno").val();
                cc = parseInt(cc) - 1;
                t.fnUpdate([sr_no,  parseFloat(group)+1, machine_id1, machine_name1, machine_id2, machine_name2,''], cc)
            }

            clearmodel();
            $('#myModal').modal('hide');
            return true;
        });


        // Edit Grid ------------------------------------------------------------------------------------------------------------------------------------------------------------------------


        $('#ContactGrid').on('click', '.edit', function () {
            var t = $('#ContactGrid').DataTable();
            var id = $(this).parent('td').parent('tr').index();
            $('#myModal').modal('show');
            $("#srno").val(t.fnGetData(id)[1]);
            var s=[t.fnGetData(id)[2],t.fnGetData(id)[4]]
            $("#machine_id").val(s).trigger("change");
            $('.machine_id').multiselect('refresh');

        });


        //DELETE GRID-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------


        $('#ContactGrid').on('click', '.delete', function () {

            var t = $('#ContactGrid').dataTable();
            var id = $(this).parent('td').parent('tr').index();
            var group = t.fnGetData(id)[1];
            swal({
                title: "Are you sure?",

                type: "warning",
                showCancelButton: true,
                confirmButtonClass: "btn-danger",
                confirmButtonText: "Yes, delete it!",
                closeOnConfirm: true
            },
            function (isConfirm) {
         if (isConfirm) {
             $.ajax({
                 url:'@Url.Action("DeleteMultiMachine", "MultiMachining")',
                 method: "POST",
                 async:false,
                 data: { group_id: group },
                 success:function(data){
                     if (data == "Deleted") {
                         swal("Deleted!", "This data has been deleted.", "success");
                         t.fnDeleteRow(id);
                     } else {
                         swal("", data, "error");
                     }

                 }

             });

         }
     });
        });

        //Create Grid-----------------------------------------------------------------------------------------------------------------------------------------------------------------------


        function TableToJson() {


            var t = $('#ContactGrid').DataTable()
            var rowCount = t.fnGetData().length;



            for (i = 0; i < rowCount; i++) {
                debugger;
                console.log(t.fnGetData(i)[2]);
                console.log(t.fnGetData(i)[4]);
                console.log(t.fnGetData(i)[1]);


                $("#mac_detail").append('<input type="hidden" id="mac_id1' + i + '" name="mac_id1" >' );
                $("#mac_detail").append('<input type="hidden" id="mac_id2' + i + '" name="mac_id2" >');
                $("#mac_detail").append('<input type="hidden" id="srnos' + i + '" name="srnos" >' );

                $("#mac_id1" + i).val(t.fnGetData(i)[2]);
                $("#mac_id2" + i).val(t.fnGetData(i)[4]);
                $("#srnos" + i).val(t.fnGetData(i)[1]);

            }


        }

    </script>
}


